<?php 
require_once("class/nomina.php"); 

$oControl=new Control(); 
$oNomina=new Nomina();

$aData["idEmpresa"]=$_SESSION["idEmpresa"];
if($_SESSION["idRol"]==2){
$aData["idUsuario"]=$_SESSION["idUsuario"];  
}

$aNomina=$oNomina->getNomina($aData);

$meses[1]="Enero"; 
$meses[2]="Febrero"; 
$meses[3]="Marzo"; 
$meses[4]="Abril"; 
$meses[5]="Mayo"; 
$meses[6]="Junio"; 
$meses[7]="Julio"; 
$meses[8]="Agosto"; 
$meses[9]="Septiembre"; 
$meses[10]="Octubre"; 
$meses[11]="Noviembre"; 
$meses[12]="Diciembre"; 
?>
<section class="section">
    <ul class="breadcrumb breadcrumb-style ">
      <li class="breadcrumb-item">
        <a href="<?php echo $URL; ?>">
          <i class="fas fa-home"></i></a>
      </li>
      <li class="breadcrumb-item">Nomina</li>
      <li class="breadcrumb-item">Listar Nominas</li>
    </ul>
    <div class="section-body">
      <div class="row">
        <div class="col-md-12 col-lg-12">
          <div class="card">
            <div class="card-header">
              <h4>Lista de nominas</h4>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-12 col-lg-12">
                      <table class="table table-striped mayusculas" id="tableNomina">
                        <thead>
                          <tr>
                            <th class="text-center">#</th>
                            <th>Fecha Registro</th>
                            <th>Periodo Pago</th>
                            <th>Valor A Pagar</th>
                            <th>Estado</th>
                            <?php if($_SESSION["idRol"]==2||$_SESSION["idRol"]==1){ ?>
                            <th>Empresa</th>
                            <?php } ?>
                            <th>Acciones</th>
                          </tr>
                        </thead>
                        <tbody>
                          <?php foreach($aNomina as $index => $iItem){ 
                            $aEncript['cadena']=$iItem['idNomina'];
                            $id=$oControl->encriptar($aEncript); 
                            $oLista=new Lista("nomina_empleado"); 
                            $oLista->setFiltro("idNomina","=",$iItem['idNomina']); 
                            $aLista=$oLista->getLista(); 
                            unset($oItem);

                            $valorNomina=0; 
                            foreach($aLista as $index=> $iLista){
                              $valorNomina+=$iLista["valorPagar"]; 
                            }
                            ?>
                            <tr>
                              <td><?php echo $index+1; ?></td>
                              <td><?php echo $iItem["fechaRegistro"]; ?></td>
                              <td><?php echo $meses[$iItem["periodoMes"]]." de ".$iItem["periodoAnio"]; ?></td>
                              <td><?php echo "$".number_format($valorNomina,0,".",","); ?></td>
                              <td><?php echo $iItem["estado"]==1?'Activa':'Procesada'; ?></td>
                              <?php if($_SESSION["idRol"]==2||$_SESSION["idRol"]==1){ ?>
                              <td><?php echo $iItem["razonSocial"]; ?></td>
                              <?php } ?>
                              <td class="centrar">
                                <a href="<?php echo $URL; ?>vernomina/<?php echo $id; ?>" data-toggle="tooltip" data-placement="top" title="Ver Nomina" class="btn btn-icon btn-sm btn-warning"><i class="fas fa-eye"></i></a>
                                <?php if($_SESSION["idRol"]==2||$_SESSION["idRol"]==1){ ?>
                                <a href="javascript:void(0)" id="<?php echo $id; ?>" data-toggle="modal" data-target="#modalNomina" data-toggle="tooltip" data-placement="top" title="Finalizar Nomina" class="btn btn-icon btn-sm btn-success finalizar"><i class="far fa-paper-plane"></i></a>
                                <?php } ?>
                              </td>
                                
                            </tr>
                          <?php } ?>
                        </tbody>
                      </table>
                    </div>
                  </div>
                  </div>
                </div>
            </div>
        </div>
    </div>
</section>
<div class="modal fade bd-example-modal-lg" id="modalNomina" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="myLargeModalLabel">Finalizar Planilla <span id="titulo" class="negrita"></span></h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form enctype="multipart/form-data" id="frmFinalizar">
            <input type="hidden" name="datos[idNomina]" id="datos[idNomina]" value="">
            <div class="row">
              <div class="col-md-12">
                <div class="form-group">
                  <label class="negrita">Url Planilla<span class="requerido">*</span>:</label>
                  <input type="url" class="form-control" placeholder="Url Planilla" name="datos[url]" id="datos[url]" required>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer bg-whitesmoke br">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
            <a class="btn btn-primary" href="javascript:void(0)" id="btnGuardar">Guardar</a>
          </div>
      </div>
    </div>
  </div>
